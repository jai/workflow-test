---
name: Incident Status Quality

on:
  schedule:
    # Every 10 minutes to evaluate the previously completed window
    - cron: "*/10 * * * *"
  # yamllint disable-line rule:empty-values
  workflow_dispatch:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: read

jobs:
  status-quality:
    if: >
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/run incident-status-quality'))
    runs-on: ubuntu-latest
    env:
      WINDOW_HOURS: ${{ vars.INCIDENT_STATUS_WINDOW_HOURS || '24' }}
      WINDOW_MINUTES: ${{ vars.INCIDENT_STATUS_WINDOW_MINUTES || '10' }}
      MAX_INCIDENTS: ${{ vars.INCIDENT_STATUS_MAX_INCIDENTS || '' }}
      INCLUDE_PASSING: ${{ vars.INCIDENT_STATUS_INCLUDE_PASSING || 'true' }}
      INCIDENT_DATA_PATH: incident-status-data.json
      INCIDENT_PROMPT_PATH: incident-status-prompt.json
      DECISIONS_PATH: incident-status-decisions.json

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('scripts/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Cache incident data
        uses: actions/cache@v4
        with:
          path: scripts/.cache
          key: status-quality-cache-${{ github.run_id }}
          restore-keys: |
            status-quality-cache-

      - name: Install dependencies
        run: pip install -r scripts/requirements.txt

      - name: Run incident status collector
        env:
          GRAFANA_TOKEN: ${{ secrets.GRAFANA_API_KEY }}
          GRAFANA_URL: https://finnapp.grafana.net
        run: |
          set -euo pipefail
          ARGS=(
            --window-hours "$WINDOW_HOURS"
            --output-json "$INCIDENT_DATA_PATH"
            --prompt-output "$INCIDENT_PROMPT_PATH"
            --cache-dir "scripts/.cache/incidents"
          )
          if [[ -n "${WINDOW_MINUTES}" ]]; then
            ARGS+=(--window-minutes "$WINDOW_MINUTES")
          fi
          if [[ -n "${MAX_INCIDENTS}" ]]; then
            ARGS+=(--max-incidents "$MAX_INCIDENTS")
          fi
          python scripts/incident_status_quality.py "${ARGS[@]}"

      - name: Inspect dataset
        id: dataset
        run: python scripts/tools/inspect_dataset.py

      - name: Prepare prompt payload
        id: prompt
        if: steps.dataset.outputs.incident_count != '0'
        run: python scripts/tools/prepare_prompt_payload.py

      - name: Evaluate status updates with Claude
        id: claude
        if: steps.dataset.outputs.incident_count != '0'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            You are auditing Grafana IRM incident status updates.

            Evaluate whether each incident's most recent human-authored status update
            (provided as JSON below) satisfies two requirements:
            1. Summarizes what has happened so far in the incident.
               - Over the course of the incident, responders are expected to explain what went wrong
                 and why (to the extent known without a full RCA) and describe the impact on
                 customers (or explicitly state if there is no impact).
               - This context may be spread across prior updates. If earlier status updates already
                 cover the trigger/impact, the latest update can focus on the delta since the last
                 entry while remaining consistent with that narrative.
               - If the historical updates do NOT cover what happened and the impact, the
                 current/latest update must include that context.
               - Attaching raw logs or screenshots without explaining them is insufficient;
                 responders must use their own words to describe the situation.
            2. Outlines clear next steps or owner follow-up actions.
            3. If a ticket/issue is referenced, ensure a hyperlink/URL is provided; missing links are a fail.

            Context:
            - Consider the look-back window (last ${{ env.WINDOW_HOURS }}h); timestamps are
              included for context only.
            - The dataset only includes incidents with at least one human-authored status update.
            - If the text is truncated, base your decision on the truncated excerpt and
              mention the limitation in notes when uncertain.
            - `all_status_updates` is ordered newest first. Use it to understand prior context
              before judging the latest status.

            INCIDENTS JSON:
            <<<INCIDENTS_JSON>>>
            ${{ steps.prompt.outputs.payload }}
            <<<END_INCIDENTS_JSON>>>

            Output EXACTLY one machine-readable line using this schema:
            STATUS_DECISIONS::[
              {
                "incident_id": "string",
                "summaryAdequate": true|false,
                "nextStepsAdequate": true|false,
                "overallStatus": "pass"|"fail",
                "notes": ["string"]
              },
              ...
            ]

            Rules:
            - Use lowercase true/false for booleans.
            - Set overallStatus to "fail" whenever either summaryAdequate or nextStepsAdequate is false.
            - Include at least one short note for every incident, explaining why it passed or failed.
            - Treat references to tickets/issues without hyperlinks/URLs as a failure
              and mention the missing link in notes.
            - Do not include extra commentary before or after the STATUS_DECISIONS line.
          claude_args: |
            --model claude-sonnet-4-5-20250929
            --max-turns 12
            --allowedTools Read

      - name: Parse Claude decisions
        id: decisions
        if: steps.dataset.outputs.incident_count != '0'
        env:
          EXECUTION_FILE: ${{ steps.claude.outputs.execution_file }}
        run: scripts/tools/parse_claude_decisions.py

      - name: Send Google Chat notification
        if: steps.dataset.outputs.incident_count != '0'
        env:
          WEBHOOK_URL: ${{ secrets.GOOGLE_CHAT_INCIDENT_STATUS_QUALITY_WEBHOOK_URL }}
        run: python scripts/tools/send_incident_status_notification.py --include-passing

      - name: Collect artifacts
        if: always()
        env:
          EXECUTION_FILE: ${{ steps.claude.outputs.execution_file }}
        run: |
          mkdir -p artifact-bundle
          cp "$INCIDENT_DATA_PATH" artifact-bundle/ 2>/dev/null || true
          cp "$INCIDENT_PROMPT_PATH" artifact-bundle/ 2>/dev/null || true
          cp "$DECISIONS_PATH" artifact-bundle/ 2>/dev/null || true
          if [[ -n "${EXECUTION_FILE}" && -f "${EXECUTION_FILE}" ]]; then
            cp "${EXECUTION_FILE}" artifact-bundle/claude-execution.json
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: incident-status-quality-${{ github.run_id }}
          path: artifact-bundle
          retention-days: 14
