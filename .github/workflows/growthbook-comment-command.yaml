# Local helper workflow derived from EWA-Services/EWA-Actions template
---
name: GrowthBook Override Comment

on:
  issue_comment:
    types:
      - created

permissions:
  actions: write
  pull-requests: read
  issues: read

jobs:
  rerun-growthbook-validation:
    name: Handle GrowthBook override comment
    if: >
      github.event.issue.pull_request != null &&
      github.event.comment.user.login != 'github-actions[bot]' &&
      github.event.comment.body != null &&
      contains(toLower(github.event.comment.body), 'no experiment')
    runs-on:
      - self-hosted
      - local
    env:
      GROWTHBOOK_SKIP_APPROVERS: jai
    steps:
      - name: Validate commenter and rerun GrowthBook Validation
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const allowedUsers = process.env.GROWTHBOOK_SKIP_APPROVERS.split(/\s+/).filter(Boolean);
            const commenter = context.payload.comment.user.login;

            if (!allowedUsers.includes(commenter)) {
              core.info(`Comment from ${commenter} is not in the approved override list. Skipping rerun.`);
              return;
            }

            const prNumber = context.payload.issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            const headSha = pr.head.sha;
            const headRef = pr.head.ref;

            const { data } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'growthbook-validation.yaml',
              branch: headRef,
              event: 'pull_request',
              per_page: 50,
            });

            const targetRun = data.workflow_runs.find(run => run.head_sha === headSha);

            if (!targetRun) {
              core.setFailed(`No GrowthBook Validation workflow run found for ${headRef} (${headSha}).`);
              return;
            }

            await github.rest.actions.reRunWorkflow({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: targetRun.id,
            });

            core.info(`Triggered rerun for GrowthBook Validation workflow run ${targetRun.id} on ${headSha}.`);
